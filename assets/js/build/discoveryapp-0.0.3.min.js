/* Gulped: Thu Apr 24 2014 04:21:44 GMT+0100 (BST) */
var app={isOnline:!1,template:"",map:"",placetypes:"",selPlaceType:[],selSearchType:"PROMINENCE",lat:"",lon:"",init:function(){"use strict";app.bindEvents(),app.getTemplate()},bindEvents:function(){"use strict";$("#actionBtn").addClass("findLocation"),$("#actionBtn").on("click",function(){if($(this).hasClass("findLocation"))app.toggleElementClass("loading_ring","block"),app.startProcess();else if($(this).hasClass("placeTypeSelect")){var e=$("#searchPlacesModal");e.addClass("slide-in-up"),$("#closePlacesModal").on("click",function(){e.removeClass("slide-in-up")})}}),$(".ion-ios7-close-empty").on("click",function(){$(".modal").removeClass("slide-in-up")}),$("#searchPlaces").on("click",function(){var e=$("#searchPlacesModal");e.addClass("slide-in-up"),$("#closePlacesModal").on("click",function(){e.removeClass("slide-in-up")})}),$("#resetZoomLevel").on("click",function(){app.googlemap.resetZoomLevel()}),$("#searchForPlaces").on("click",function(){var e=$("#map").data("lat"),a=$("#map").data("lon");app.selPlaceType=[],app.googlemap.clearMarkers(),app.selPlaceType.push($("#placeSelectParent").find(":selected").val()),app.googlemap.getPlacesByCoords(e,a,app.selPlaceType),$("#searchPlacesModal").removeClass("slide-in-up")})},toggleHeaderButtons:function(e){$.each($(".bar-header .button"),function(a,o){$(o).css("display",e)})},startProcess:function(){var e=$("#actionBtn");e.html("Tracking you down... don't move.").removeClass("button-energized").addClass("button-stable"),invokeCFClientFunction("getCurrentLocation",function(a){-1===a?(e.html("I was unable to find you. Try again?").removeClass("button-stable").addClass("button-energized"),app.toggleElementClass("loading_ring","none"),app.toggleHeaderButtons("none"),console.log("Timed out in invokeCFClientFunction for getCurrentLocation")):(e.html("Got you!"),app.googlemap.generateMap(a.coords.latitude,a.coords.longitude),invokeCFClientFunction("getAllPlaceTypes",function(o){var t={places:o};$(".placeSelectionHolder").html(Mustache.render(app.template.filter("#placeTypeSelectRenderTpl").html(),t)),$("#map").css("visibility","visible").css("display","block"),app.toggleElementClass("loading_ring","none"),e.html("Select a place type").addClass("placeTypeSelect").removeClass("findLocation").removeClass("button-stable").addClass("button-energized"),app.toggleHeaderButtons("block"),$("#map").data("lat",a.coords.latitude),$("#map").data("lon",a.coords.longitude)}))})},toggleElementClass:function(e,a){$("."+e).css("display",a)},getTemplate:function(){"use strict";$.get("assets/templates/mustache.html",function(e){app.template=$(e),app.docReady()})},loadPlacetypes:function(){"use strict";$.get("assets/place_types.json",function(e){populateTypeTable(e)})},docReady:function(){"use strict";var e;app.loadPlacetypes(),e=showConnectionType(),app.isOnline=app.manageConnection(e),app.isOnline&&$("#actionBtn").css("display","block")},connectionOff:function(){"use strict";invokeCFClientFunction("showConnectionType",function(e){app.isOnline=app.manageConnection(e)})},connectionOn:function(){"use strict";invokeCFClientFunction("showConnectionType",function(e){app.isOnline=app.manageConnection(e)})},manageConnection:function(e){"use strict";switch(e){case"none":return app.toggleElementClass("bgoverlay","block"),app.toggleElementClass("loading_ring","block"),!1;default:return app.toggleElementClass("bgoverlay","none"),app.toggleElementClass("loading_ring","none"),!0}},flickr:{baseURL:"http://api.flickr.com/services/rest/",api_key:"fe2a32290c7d39d8617b6b16685a5217",getLocationPhotos:function(e,a){"use strict";$.ajax({url:app.flickr.baseURL,type:"GET",data:{method:"flickr.photos.search",group_id:"1463451@N25",safe_search:1,jsoncallback:"app.flickr.locationPhotoResponse",api_key:app.flickr.api_key,lat:e,lon:a,format:"json"},dataType:"jsonp"})},locationPhotoResponse:function(e){"use strict";var a=e.photos.photo.length,o="";a&&(o=e.photos.photo[app.flickr.pickRandRange(0,a)],void 0===o?(o=e.photos.photo[0],app.flickr.getLargePhotoByID(o.id)):app.flickr.getLargePhotoByID(o.id))},getLargePhotoByID:function(e){"use strict";$.ajax({url:app.flickr.baseURL,type:"GET",data:{method:"flickr.photos.getSizes",photo_id:e,jsoncallback:"app.flickr.getPhotoImageResponse",api_key:app.flickr.api_key,format:"json"},dataType:"jsonp"})},getPhotoImageResponse:function(e){"use strict";var a=e.sizes.size;a.length&&$.each(a,function(e,a){"Medium"===a.label&&$("body").css("background-image","url("+a.source+")")})},pickRandRange:function(e,a){"use strict";return Math.floor(Math.random()*(a-e+1))+e}},googlemap:{map:"",service:"",infowindow:"",placeMarkers:[],api_key:"AIzaSyDB3TA-c8elVRPcjFDYLqJ3K1VNmU7r_Ys",bounds:"",resetZoomLevel:function(){app.googlemap.map.setZoom(15)},generateMap:function(e,a){"use strict";var o=new google.maps.LatLng(e,a);app.googlemap.map=new google.maps.Map(document.getElementById("map"),{center:o,zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,mapTypeControl:!1});new google.maps.Marker({position:o,map:app.googlemap.map,icon:new google.maps.MarkerImage("assets/img/client-location.svg",null,null,null,new google.maps.Size(40,40))})},getPlacesByCoords:function(e,a,o){"use strict";var t=$("#actionBtn"),n=new google.maps.LatLngBounds,l=new google.maps.LatLng(e,a),s={location:l,types:o,rankBy:google.maps.places.RankBy.DISTANCE},p=0;t.html("Plotting results...").removeClass("placeTypeSelect").removeClass("findLocation").removeClass("button-energized").addClass("button-stable"),app.toggleElementClass("loading_ring","block"),app.googlemap.service=new google.maps.places.PlacesService(app.googlemap.map),app.googlemap.service.nearbySearch(s,function(e,a){if(console.log(e),console.log(a),a===google.maps.places.PlacesServiceStatus.OK)for(p=0;p<e.length;p++){var o=e[p];app.googlemap.createMarker(o)}for(var l in app.googlemap.placeMarkers)n.extend(app.googlemap.placeMarkers[l].getPosition());app.toggleElementClass("loading_ring","none"),t.html("Select a place type").addClass("placeTypeSelect").removeClass("findLocation").removeClass("button-stable").addClass("button-energized"),app.googlemap.map.fitBounds(n)})},clearMarkers:function(){"use strict";if(app.googlemap.placeMarkers.length){for(var e=0;e<app.googlemap.placeMarkers.length;e++)app.googlemap.placeMarkers[e].setMap(null);app.googlemap.placeMarkers=[]}},createMarker:function(e){"use strict";var a=$("#actionBtn"),o=e.geometry.location,t=new google.maps.MarkerImage("assets/img/marker.svg",null,null,null,new google.maps.Size(40,40)),n=new google.maps.Marker({map:app.googlemap.map,position:o,title:e.name,icon:t});app.googlemap.placeMarkers.push(n),google.maps.event.addListener(n,"click",function(){var o={reference:e.reference};app.toggleElementClass("loading_ring","block"),a.html("Getting details...").removeClass("placeTypeSelect").removeClass("findLocation"),app.googlemap.service.getDetails(o,function(o,t){if(t==google.maps.places.PlacesServiceStatus.OK){if(app.toggleElementClass("loading_ring","none"),a.html("Select a place type").addClass("placeTypeSelect").removeClass("findLocation"),e.photos){var n=e.photos[0].getUrl({maxWidth:268,maxHeight:151});o.photo=n}o.human_time=function(){var e=1e3*this.time,a=new Date(e);return moment(a).fromNow()},o.openLTFormat=function(){return moment(this.open.nextDate).format("LT")},o.closeLTFormat=function(){return moment(this.close.nextDate).format("LT")},o.dayOfWeekFromInt=function(){var e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return e[this.open.day]},$("#placeDetailModalContent").html(Mustache.render(app.template.filter("#placeDetailModalRenderTpl").html(),o)),$("#placeDetailModal").addClass("slide-in-up")}})})}}},QueryToObject=function(e){var a,o,t,n,l,s,p,i;for(i=[],o=0,s=e.ROWCOUNT;s>=0?s>o:o>s;s>=0?o++:o--){for(t={},p=e.COLUMNS,n=0,l=p.length;l>n;n++)a=p[n],t[a.toLowerCase()]=e.DATA[a][o];i.push(t)}return i};